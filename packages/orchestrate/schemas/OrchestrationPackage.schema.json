{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://orchestrate.dev/schemas/OrchestrationPackage.schema.json",
  "title": "OrchestrationPackage",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "packageVersion",
    "metadata",
    "objective",
    "agents",
    "registries",
    "runPolicy"
  ],
  "properties": {
    "packageVersion": {
      "type": "string",
      "pattern": "^v?[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["packageId", "createdAt", "createdBy"],
      "properties": {
        "packageId": { "type": "string", "minLength": 1 },
        "createdAt": { "type": "string", "format": "date-time" },
        "createdBy": { "type": "string", "minLength": 1 },
        "source": { "type": "string" },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "default": []
        }
      }
    },
    "objective": {
      "type": "object",
      "additionalProperties": false,
      "required": ["title", "description", "doneCriteria"],
      "properties": {
        "title": { "type": "string", "minLength": 1 },
        "description": { "type": "string", "minLength": 1 },
        "inputs": {
          "type": "object",
          "additionalProperties": true,
          "default": {}
        },
        "doneCriteria": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["id", "description", "requiredEvidenceTypes"],
            "properties": {
              "id": { "type": "string" },
              "description": { "type": "string" },
              "requiredEvidenceTypes": {
                "type": "array",
                "minItems": 1,
                "items": {
                  "type": "string",
                  "enum": ["test_result", "log_excerpt", "diff", "artifact", "metric", "screenshot"]
                }
              }
            }
          }
        }
      }
    },
    "agents": {
      "type": "object",
      "additionalProperties": false,
      "required": ["orchestrator", "worker"],
      "properties": {
        "orchestrator": {
          "type": "object",
          "additionalProperties": false,
          "required": ["name", "model", "systemPromptRef"],
          "properties": {
            "name": { "type": "string" },
            "model": { "type": "string" },
            "systemPromptRef": { "type": "string" },
            "temperature": { "type": "number", "minimum": 0, "maximum": 1, "default": 0 }
          }
        },
        "worker": {
          "type": "object",
          "additionalProperties": false,
          "required": ["name", "model", "systemPromptRef"],
          "properties": {
            "name": { "type": "string" },
            "model": { "type": "string" },
            "systemPromptRef": { "type": "string" },
            "temperature": { "type": "number", "minimum": 0, "maximum": 1, "default": 0 }
          }
        }
      }
    },
    "registries": {
      "type": "object",
      "additionalProperties": false,
      "required": ["skills", "variables"],
      "properties": {
        "skills": {
          "type": "array",
          "items": { "type": "object", "additionalProperties": true }
        },
        "variables": {
          "type": "array",
          "items": { "type": "object", "additionalProperties": true }
        },
        "functions": {
          "type": "array",
          "default": [],
          "items": { "type": "object", "additionalProperties": true }
        },
        "uiSpecs": {
          "type": "array",
          "default": [],
          "items": { "type": "object", "additionalProperties": true }
        }
      }
    },
    "runPolicy": {
      "type": "object",
      "additionalProperties": false,
      "required": ["limits", "retries", "concurrency", "timeouts", "budget", "determinism"],
      "properties": {
        "limits": {
          "type": "object",
          "additionalProperties": false,
          "required": ["maxOrchestratorIterations", "maxWorkerIterations", "maxRunWallClockMs"],
          "properties": {
            "maxOrchestratorIterations": { "type": "integer", "minimum": 1 },
            "maxWorkerIterations": { "type": "integer", "minimum": 1 },
            "maxRunWallClockMs": { "type": "integer", "minimum": 1000 }
          }
        },
        "retries": {
          "type": "object",
          "additionalProperties": false,
          "required": ["maxWorkerTaskRetries", "maxMalformedOutputRetries"],
          "properties": {
            "maxWorkerTaskRetries": { "type": "integer", "minimum": 0 },
            "maxMalformedOutputRetries": { "type": "integer", "minimum": 0 }
          }
        },
        "concurrency": {
          "type": "object",
          "additionalProperties": false,
          "required": ["maxWorkers"],
          "properties": {
            "maxWorkers": { "type": "integer", "minimum": 1 }
          }
        },
        "timeouts": {
          "type": "object",
          "additionalProperties": false,
          "required": ["workerTaskMs", "orchestratorStepMs"],
          "properties": {
            "workerTaskMs": { "type": "integer", "minimum": 1000 },
            "orchestratorStepMs": { "type": "integer", "minimum": 1000 }
          }
        },
        "budget": {
          "type": "object",
          "additionalProperties": false,
          "required": ["maxTokens", "maxCostUsd"],
          "properties": {
            "maxTokens": { "type": "integer", "minimum": 1 },
            "maxCostUsd": { "type": "number", "minimum": 0 }
          }
        },
        "determinism": {
          "type": "object",
          "additionalProperties": false,
          "required": ["enforceStageOrder", "requireStrictJson", "singleSessionPerRun"],
          "properties": {
            "enforceStageOrder": { "type": "boolean", "const": true },
            "requireStrictJson": { "type": "boolean", "const": true },
            "singleSessionPerRun": { "type": "boolean", "const": true }
          }
        }
      }
    }
    ,
    "preview": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean", "default": false },
        "command": { "type": "string" },
        "args": { "type": "array", "items": { "type": "string" }, "default": [] },
        "cwd": { "type": "string" },
        "readyPath": { "type": "string", "default": "/" },
        "autoStopOnTerminal": { "type": "boolean", "default": true }
      }
    },
    "git": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean", "default": false },
        "repoPath": { "type": "string" },
        "worktreesRoot": { "type": "string" },
        "baseBranch": { "type": "string", "default": "main" },
        "integrationBranch": { "type": "string", "default": "integration" },
        "requireChecks": { "type": "array", "items": { "type": "string" }, "default": [] },
        "identity": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "userName": { "type": "string" },
            "userEmail": { "type": "string" },
            "sshCommand": { "type": "string" }
          }
        }
      }
    }
  }
}
